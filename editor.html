<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Editor (Private)</title>

<style>
    body { font-family: Arial; background: #f2f2f2; margin: 0; }
    header { background: #007bff; padding: 20px; color: white; text-align: center; }
    .container {
        max-width: 900px; margin: 30px auto; background: white;
        padding: 25px; border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #editor {
        width: 100%; min-height: 220px; padding: 15px;
        border: 1px solid #aaa; border-radius: 6px;
        background: white; font-size: 16px;
    }
    input, button {
        padding: 12px; margin: 7px 0; border-radius: 6px;
        border: 1px solid #999; font-size: 16px;
    }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    .toolbar button { background: #eee; color: #222; border: none; }
    .post { padding: 20px; background: #fafafa; border-left: 4px solid #007bff; margin: 15px 0; }
    .delete-btn { background: #d9534f; }
</style>
</head>
<body>

<header>
    <h1>Blog Editor (Private)</h1>
    <p>Create and upload posts to GitHub</p>
</header>

<div class="container">
    <h2>Create a New Post</h2>

    <input id="title" placeholder="Post title">

    <div class="toolbar">
        <button onclick="format('bold')"><b>B</b></button>
        <button onclick="format('italic')"><i>I</i></button>
        <button onclick="format('underline')"><u>U</u></button>
        <button onclick="format('insertUnorderedList')">‚Ä¢ List</button>
        <button onclick="format('insertOrderedList')">1. List</button>
    </div>

    <div id="editor" contenteditable="true"></div>

    <button onclick="saveLocal()">Save Locally</button>
    <button onclick="uploadGitHub()">Upload to GitHub</button>

    <h2>Local Posts</h2>
    <div id="posts"></div>
</div>

<script>
function format(cmd){ document.execCommand(cmd,false,null); }

let posts = JSON.parse(localStorage.getItem("posts")||"[]");
showPosts();

function saveLocal(){
    const t=document.getElementById("title").value;
    const c=document.getElementById("editor").innerHTML;
    if(!t||!c.trim()) return alert("Missing title/content");

    posts.unshift({ 
        id:Date.now(), 
        title:t, 
        content:c, 
        date:new Date().toLocaleString(),
        githubFile: null // stored after upload
    });

    localStorage.setItem("posts",JSON.stringify(posts));
    showPosts();
}

function showPosts(){
    let div=document.getElementById("posts");
    div.innerHTML="";
    posts.forEach(p=>{
        div.innerHTML+=`
            <div class="post">
                <h3>${p.title}</h3>
                <small>${p.date}</small>
                <div>${p.content}</div>
                <button class="delete-btn" onclick="del(${p.id})">Delete Locally</button>

                ${p.githubFile ? `
                    <button onclick="deleteGitHub('${p.githubFile}')">Delete on GitHub</button>
                ` : ""}
            </div>`;
    });
}

function del(id){
    posts=posts.filter(p=>p.id!==id);
    localStorage.setItem("posts",JSON.stringify(posts));
    showPosts();
}

// Convert UTF8 ‚Üí Base64
function toBase64(str){
    return btoa(String.fromCharCode(...new TextEncoder().encode(str)));
}

async function uploadGitHub() {
    let token = prompt("GitHub TOKEN:");
    let user = prompt("GitHub USERNAME:");
    let repo = prompt("Repo name:");

    const title = document.getElementById("title").value;
    const body = document.getElementById("editor").innerHTML;

    if (!title || !body.trim()) {
        alert("Missing title/content");
        return;
    }

    const filename = `posts/${title.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.html`;
    const html = `<h1>${title}</h1><p><i>${new Date().toLocaleString()}</i></p><hr>${body}`;

    const encoded = toBase64(html);

    // Upload to GitHub
    let res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${filename}`, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "X-GitHub-Api-Version": "2022-11-28"
        },
        body: JSON.stringify({
            message: "New post",
            content: encoded
        })
    });

    const result = await res.json();

    if (res.ok) {
        alert("Uploaded ‚úî");

        // Save GitHub path to the local post
        posts[0].githubFile = filename;
        localStorage.setItem("posts", JSON.stringify(posts));
        showPosts();

        // CLEAR EDITOR + TITLE
        document.getElementById("title").value = "";
        document.getElementById("editor").innerHTML = "";
    } else {
        alert("Upload failed ‚ùå\n" + JSON.stringify(result, null, 2));
    }
}

// üî• NEW ‚Äî Delete GitHub post
async function deleteGitHub(path) {
    let token = prompt("GitHub TOKEN:");
    let user = prompt("GitHub USERNAME:");
    let repo = prompt("Repo name:");

    // Get SHA of existing file
    let fileInfo = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`, {
        headers: {
            "Authorization": `Bearer ${token}`
        }
    });

    if (!fileInfo.ok) {
        alert("Failed to fetch file info.");
        return;
    }

    let info = await fileInfo.json();

    let res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`, {
        method: "DELETE",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "X-GitHub-Api-Version": "2022-11-28"
        },
        body: JSON.stringify({
            message: "Delete post",
            sha: info.sha
        })
    });

    if (res.ok) {
        alert("Deleted on GitHub ‚úî");

        // remove githubFile from local post
        posts = posts.map(p => {
            if (p.githubFile === path) p.githubFile = null;
            return p;
        });

        localStorage.setItem("posts", JSON.stringify(posts));
        showPosts();
    } else {
        const err = await res.json();
        alert("Delete failed ‚ùå\n" + JSON.stringify(err, null, 2));
    }
}
</script>

</body>
</html>
